name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  SCHEME: NativeYoutube
  PRODUCT_NAME: NativeYoutube
  XCODE_VERSION: "16.3"

jobs:
  build-and-release:
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"

      - name: Import Developer ID certificate
        env:
          CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          # Save for cleanup
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/certificate.p12"
          security import "$RUNNER_TEMP/certificate.p12" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" "$(security list-keychains -d user | tr -d '"' | tr '\n' ' ')"

      - name: Setup App Store Connect API key
        env:
          API_KEY_P8: ${{ secrets.APPLE_API_KEY_P8 }}
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY_P8" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Resolve SPM packages
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
          xcodebuild -resolvePackageDependencies \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm"

      - name: Archive
        run: |
          xcodebuild archive \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/${{ env.SCHEME }}.xcarchive" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            OTHER_CODE_SIGN_FLAGS="--timestamp"

      - name: Create export options plist
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>TEAM_ID_PLACEHOLDER</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Developer ID Application</string>
          </dict>
          </plist>
          PLIST

          sed -i '' "s/TEAM_ID_PLACEHOLDER/${{ secrets.APPLE_TEAM_ID }}/" "$RUNNER_TEMP/ExportOptions.plist"

      - name: Export archive
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/${{ env.SCHEME }}.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/export"

      - name: Notarize app
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          ditto -c -k --keepParent "$RUNNER_TEMP/export/${{ env.PRODUCT_NAME }}.app" "$RUNNER_TEMP/app-for-notarization.zip"

          xcrun notarytool submit "$RUNNER_TEMP/app-for-notarization.zip" \
            --key ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            --key-id "$API_KEY_ID" \
            --issuer "$API_ISSUER_ID" \
            --wait

      - name: Staple app
        run: xcrun stapler staple "$RUNNER_TEMP/export/${{ env.PRODUCT_NAME }}.app"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="${{ env.PRODUCT_NAME }}-${VERSION}.dmg"
          DMG_PATH="$RUNNER_TEMP/$DMG_NAME"
          APP_PATH="$RUNNER_TEMP/export/${{ env.PRODUCT_NAME }}.app"

          set +e
          create-dmg \
            --volname "Native Youtube" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "${{ env.PRODUCT_NAME }}.app" 200 200 \
            --hide-extension "${{ env.PRODUCT_NAME }}.app" \
            --app-drop-link 400 200 \
            --no-internet-enable \
            "$DMG_PATH" \
            "$APP_PATH"
          EXIT_CODE=$?
          set -e

          # create-dmg returns 2 when it can't set custom icon (non-fatal)
          if [ $EXIT_CODE -ne 0 ] && [ $EXIT_CODE -ne 2 ]; then
            exit $EXIT_CODE
          fi

          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"
          echo "DMG_PATH=$DMG_PATH" >> "$GITHUB_ENV"

      - name: Sign DMG
        run: |
          codesign --force --sign "Developer ID Application: Aayush Pokharel (${{ secrets.APPLE_TEAM_ID }})" \
            --timestamp \
            "$DMG_PATH"

      - name: Notarize DMG
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          xcrun notarytool submit "$DMG_PATH" \
            --key ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            --key-id "$API_KEY_ID" \
            --issuer "$API_ISSUER_ID" \
            --wait

          xcrun stapler staple "$DMG_PATH"

      - name: Upload DMG to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ runner.temp }}/${{ env.DMG_NAME }}
          tag_name: ${{ github.event.release.tag_name }}

      - name: Cleanup
        if: always()
        run: |
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          rm -f ~/private_keys/AuthKey_*.p8
          rm -f "$RUNNER_TEMP/certificate.p12"
          rm -f "$RUNNER_TEMP/app-for-notarization.zip"
