name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  SCHEME: NativeYoutube
  PRODUCT_NAME: NativeYoutube
  XCODE_VERSION: "16.3"
  SPARKLE_VERSION: "2.8.1"

jobs:
  build-and-release:
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"

      - name: Import Developer ID certificate
        env:
          CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/certificate.p12"
          security import "$RUNNER_TEMP/certificate.p12" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" "$(security list-keychains -d user | tr -d '"' | tr '\n' ' ')"

      - name: Setup App Store Connect API key
        env:
          API_KEY_P8: ${{ secrets.APPLE_API_KEY_P8 }}
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY_P8" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Download Sparkle
        run: |
          curl -L -o "$RUNNER_TEMP/Sparkle.tar.xz" \
            "https://github.com/sparkle-project/Sparkle/releases/download/${{ env.SPARKLE_VERSION }}/Sparkle-${{ env.SPARKLE_VERSION }}.tar.xz"
          mkdir -p "$RUNNER_TEMP/sparkle-tools"
          tar -xf "$RUNNER_TEMP/Sparkle.tar.xz" -C "$RUNNER_TEMP/sparkle-tools"

      - name: Resolve SPM packages
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
          xcodebuild -resolvePackageDependencies \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm"

      - name: Archive
        run: |
          xcodebuild archive \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/${{ env.SCHEME }}.xcarchive" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            OTHER_CODE_SIGN_FLAGS="--timestamp"

      - name: Create export options plist
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>TEAM_ID_PLACEHOLDER</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Developer ID Application</string>
          </dict>
          </plist>
          PLIST

          sed -i '' "s/TEAM_ID_PLACEHOLDER/${{ secrets.APPLE_TEAM_ID }}/" "$RUNNER_TEMP/ExportOptions.plist"

      - name: Export archive
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/${{ env.SCHEME }}.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/export"

      - name: Notarize app
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          ditto -c -k --keepParent "$RUNNER_TEMP/export/${{ env.PRODUCT_NAME }}.app" "$RUNNER_TEMP/app-for-notarization.zip"

          xcrun notarytool submit "$RUNNER_TEMP/app-for-notarization.zip" \
            --key ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            --key-id "$API_KEY_ID" \
            --issuer "$API_ISSUER_ID" \
            --wait

      - name: Staple app
        run: xcrun stapler staple "$RUNNER_TEMP/export/${{ env.PRODUCT_NAME }}.app"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="${{ env.PRODUCT_NAME }}-${VERSION}.dmg"
          DMG_PATH="$RUNNER_TEMP/$DMG_NAME"
          APP_PATH="$RUNNER_TEMP/export/${{ env.PRODUCT_NAME }}.app"

          set +e
          create-dmg \
            --volname "Native Youtube" \
            --volicon "dmg-assets/VolumeIcon.icns" \
            --background "dmg-assets/dmg-bg@2x.jpg" \
            --window-pos 200 120 \
            --window-size 560 350 \
            --icon-size 80 \
            --icon "${{ env.PRODUCT_NAME }}.app" 150 165 \
            --hide-extension "${{ env.PRODUCT_NAME }}.app" \
            --app-drop-link 410 165 \
            --no-internet-enable \
            "$DMG_PATH" \
            "$APP_PATH"
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] && [ $EXIT_CODE -ne 2 ]; then
            exit $EXIT_CODE
          fi

          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"
          echo "DMG_PATH=$DMG_PATH" >> "$GITHUB_ENV"

      - name: Sign DMG
        run: |
          codesign --force --sign "Developer ID Application: Aayush Pokharel (${{ secrets.APPLE_TEAM_ID }})" \
            --timestamp \
            "$DMG_PATH"

      - name: Notarize DMG
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          xcrun notarytool submit "$DMG_PATH" \
            --key ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            --key-id "$API_KEY_ID" \
            --issuer "$API_ISSUER_ID" \
            --wait

          xcrun stapler staple "$DMG_PATH"

      - name: Generate appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          SIGN_UPDATE="$RUNNER_TEMP/sparkle-tools/bin/sign_update"
          chmod +x "$SIGN_UPDATE"

          # Sign DMG with EdDSA key
          RAW_OUTPUT=$(echo "$SPARKLE_PRIVATE_KEY" | "$SIGN_UPDATE" "$DMG_PATH" --ed-key-file -)
          ED_SIGNATURE=$(echo "$RAW_OUTPUT" | sed -n 's/.*sparkle:edSignature="\([^"]*\)".*/\1/p')
          FILE_SIZE=$(stat -f%z "$DMG_PATH")

          export VERSION="${{ steps.version.outputs.version }}"
          export BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          export DOWNLOAD_URL="https://f005.backblazeb2.com/file/${{ secrets.B2_BUCKET_NAME }}/releases/${DMG_NAME}"
          export ED_SIGNATURE
          export FILE_SIZE

          python3 - "$RUNNER_TEMP/appcast.xml" <<'PYEOF'
          import sys, os
          from datetime import datetime, timezone

          pub_date = datetime.now(timezone.utc).strftime("%a, %d %b %Y %H:%M:%S +0000")
          xml = '<?xml version="1.0" encoding="utf-8"?>\n'
          xml += '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">\n'
          xml += '  <channel>\n'
          xml += '    <title>Native Youtube</title>\n'
          xml += '    <link>https://github.com/Aayush9029/NativeYoutube</link>\n'
          xml += '    <description>Most recent changes with links to updates.</description>\n'
          xml += '    <language>en</language>\n'
          xml += '    <item>\n'
          xml += f'      <title>Version {os.environ["VERSION"]}</title>\n'
          xml += f'      <pubDate>{pub_date}</pubDate>\n'
          xml += f'      <sparkle:version>{os.environ["BUILD_NUMBER"]}</sparkle:version>\n'
          xml += f'      <sparkle:shortVersionString>{os.environ["VERSION"]}</sparkle:shortVersionString>\n'
          xml += '      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>\n'
          xml += '      <enclosure\n'
          xml += f'        url="{os.environ["DOWNLOAD_URL"]}"\n'
          xml += f'        sparkle:edSignature="{os.environ["ED_SIGNATURE"]}"\n'
          xml += f'        length="{os.environ["FILE_SIZE"]}"\n'
          xml += '        type="application/octet-stream"\n'
          xml += '      />\n'
          xml += '    </item>\n'
          xml += '  </channel>\n'
          xml += '</rss>\n'

          with open(sys.argv[1], "w") as f:
              f.write(xml)
          PYEOF

      - name: Install B2 CLI
        run: pip3 install --break-system-packages 'docutils<0.22' 'b2[full]==4.2.0'

      - name: Upload to Backblaze B2
        env:
          B2_APPLICATION_KEY_ID: ${{ secrets.B2_APPLICATION_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
        run: |
          b2 account authorize "$B2_APPLICATION_KEY_ID" "$B2_APPLICATION_KEY"
          b2 file upload "$B2_BUCKET_NAME" "$DMG_PATH" "releases/$DMG_NAME"
          b2 file upload --content-type "application/xml" "$B2_BUCKET_NAME" "$RUNNER_TEMP/appcast.xml" "appcast.xml"

      - name: Verify deployment
        run: |
          # Verify appcast XML is valid
          python3 -c "
          import xml.etree.ElementTree as ET
          ET.parse('$RUNNER_TEMP/appcast.xml')
          print('Appcast XML is valid')
          "

          # Verify DMG is accessible on B2
          HTTP_STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
            "https://f005.backblazeb2.com/file/${{ secrets.B2_BUCKET_NAME }}/releases/$DMG_NAME")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "WARNING: DMG returned HTTP $HTTP_STATUS (may need time to propagate)"
          else
            echo "DMG accessible on B2 (HTTP 200)"
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          rm -f ~/private_keys/AuthKey_*.p8
          rm -f "$RUNNER_TEMP/certificate.p12"
          rm -f "$RUNNER_TEMP/app-for-notarization.zip"
