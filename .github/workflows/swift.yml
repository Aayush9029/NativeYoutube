name: Swift

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    - name: Select latest Xcode
      run: |
        LATEST_XCODE_PATH=$(
          find /Applications -maxdepth 1 -name 'Xcode_*.app' -type d -print \
            | sed -E 's#^/Applications/Xcode_([0-9][0-9.]*)\.app$#\1 \0#' \
            | sort -V \
            | tail -n1 \
            | cut -d' ' -f2-
        )

        if [[ -z "${LATEST_XCODE_PATH:-}" ]]; then
          LATEST_XCODE_PATH="/Applications/Xcode.app"
        fi

        echo "Selecting Xcode: $LATEST_XCODE_PATH"
        sudo xcode-select -s "$LATEST_XCODE_PATH/Contents/Developer"
        /usr/bin/xcodebuild -version
    - name: Configure Xcode defaults
      run: |
        set -e
        # Check if the defaults exist before trying to delete them
        defaults read com.apple.dt.Xcode IDEPackageOnlyUseVersionsFromResolvedFile 2>/dev/null && defaults delete com.apple.dt.Xcode IDEPackageOnlyUseVersionsFromResolvedFile || true
        defaults read com.apple.dt.Xcode IDEDisableAutomaticPackageResolution 2>/dev/null && defaults delete com.apple.dt.Xcode IDEDisableAutomaticPackageResolution || true
        defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
    - name: Build
      run: xcodebuild -scheme NativeYoutube -destination 'platform=macOS' build
